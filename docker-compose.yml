version: '3.8'

services:
# Start zookeeper
  zookeeper:
    image: apachepulsar/pulsar:latest
    profiles: ["pulsar"]
    container_name: zookeeper
    restart: on-failure
    networks:
      - alpespartners-network
    volumes:
      - ./data/zookeeper:/pulsar/data/zookeeper
    environment:
      - metadataStoreUrl=zk:zookeeper:2181
    command: >
      bash -c "bin/apply-config-from-env.py conf/zookeeper.conf && \
             bin/generate-zookeeper-config.sh conf/zookeeper.conf && \
             exec bin/pulsar zookeeper"
    healthcheck:
      test: ["CMD", "bin/pulsar-zookeeper-ruok.sh"]
      interval: 10s
      timeout: 5s
      retries: 30

# Init cluster metadata
  pulsar-init:
    container_name: pulsar-init
    hostname: pulsar-init
    image: apachepulsar/pulsar:latest
    profiles: ["pulsar"]
    networks:
      - alpespartners-network
    command: bin/pulsar initialize-cluster-metadata --cluster cluster-a --zookeeper zookeeper:2181 --configuration-store zookeeper:2181 --web-service-url http://broker:8080 --broker-service-url pulsar://broker:6650
    depends_on:
      zookeeper:
        condition: service_healthy

# Start bookie
  bookie:
    image: apachepulsar/pulsar:latest
    profiles: ["pulsar"]
    container_name: bookie
    restart: on-failure
    networks:
      - alpespartners-network
    environment:
      - clusterName=cluster-a
      - zkServers=zookeeper:2181
      - metadataServiceUri=metadata-store:zk:zookeeper:2181
    depends_on:
      zookeeper:
        condition: service_healthy
      pulsar-init:
        condition: service_completed_successfully
  # Map the local directory to the container to avoid bookie startup failure due to insufficient container disks.
    volumes:
      - ./data/bookkeeper:/pulsar/data/bookkeeper
    command: bash -c "bin/apply-config-from-env.py conf/bookkeeper.conf && exec bin/pulsar bookie"

# Start broker
  broker:
    image: apachepulsar/pulsar:latest
    profiles: ["pulsar"]
    container_name: broker
    hostname: broker
    restart: on-failure
    networks:
      - alpespartners-network
    environment:
      - metadataStoreUrl=zk:zookeeper:2181
      - zookeeperServers=zookeeper:2181
      - clusterName=cluster-a
      - managedLedgerDefaultEnsembleSize=1
      - managedLedgerDefaultWriteQuorum=1
      - managedLedgerDefaultAckQuorum=1
      - advertisedAddress=broker
      #Si se realiza una ejecución manual del microservicio desde el IDE, se debe usar esta línea:
      # - advertisedListeners=external:pulsar://127.0.0.1:6650
      #Si se realiza una ejecución completa de todo (incluido el microservicio) con docker compose, se debería usar esta línea en lugar de la anterior para que se comunique con el contenedor broker dentro de una misma ejecución
      - advertisedListeners=external:pulsar://broker:6650
    depends_on:
      zookeeper:
        condition: service_healthy
      bookie:
        condition: service_started
    ports:
      - "6650:6650"
      - "8080:8080"
    command: bash -c "bin/apply-config-from-env.py conf/broker.conf
      &&  exec bin/pulsar broker"

  mongodb:
    image: mongo:7.0
    profiles: ["alpespartners", "mongodb"]
    container_name: alpespartners-mongodb
    ports:
      - "27017:27017"
    command: mongod --quiet
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: admin123
      MONGO_INITDB_DATABASE: alpespartners
    volumes:
      - ./mongo_data:/data/db
    networks:
      - alpespartners-network
  marketing:
    build:
      context: .
      dockerfile: marketing.Dockerfile
    profiles: ["alpespartners"]
    container_name: marketing
    restart: unless-stopped
    command: 
      - sh
      - -c
      - |
        python -m debugpy --listen 0.0.0.0:5678 -m flask --app src/marketing/api run --host=0.0.0.0 -p 8000 --reload
    ports:
      - "8000:8000"
      - "5678:5678"
    volumes:
      - ./src/marketing/:/src/marketing/
    environment:
      - DATABASE_TYPE=mongodb
      - MONGODB_URI=mongodb://admin:admin123@mongodb:27017/alpespartners?authSource=admin
      - BROKER_HOST=broker
      - PYTHONUNBUFFERED=1
    depends_on:
      - mongodb
    networks:
      - alpespartners-network
  tracking:
    build:
      context: .
      dockerfile: tracking.Dockerfile
    profiles: ["alpespartners"]
    container_name: tracking
    restart: unless-stopped
    command: 
      - sh
      - -c
      - |
        python -m debugpy --listen 0.0.0.0:5678 -m flask --app src/tracking/api run --host=0.0.0.0 -p 8000 --reload
    ports:
      - "8001:8000"
      - "5679:5678"
    volumes:
      - ./src/tracking/:/src/tracking/
    environment:
      - DATABASE_TYPE=mongodb
      - MONGODB_URI=mongodb://admin:admin123@mongodb:27017/alpespartners?authSource=admin
      - BROKER_HOST=broker
      - PYTHONUNBUFFERED=1
    depends_on:
      - mongodb
    networks:
      - alpespartners-network
  comisiones:
    build:
      context: .
      dockerfile: comisiones.Dockerfile
    profiles: ["alpespartners"]
    container_name: comisiones
    restart: unless-stopped
    command: 
      - sh
      - -c
      - |
        python -m debugpy --listen 0.0.0.0:5678 -m flask --app src/comisiones/api run --host=0.0.0.0 -p 8000 --reload
    ports:
      - "8003:8000"
      - "5680:5678"
    volumes:
      - ./src/comisiones/:/src/comisiones/
    environment:
      - DATABASE_TYPE=mongodb
      - MONGODB_URI=mongodb://admin:admin123@mongodb:27017/alpespartners?authSource=admin
      - BROKER_HOST=broker
      - PYTHONUNBUFFERED=1
    depends_on:
      - mongodb
    networks:
      - alpespartners-network
  atribucion:
    build:
      context: .
      dockerfile: atribucion.Dockerfile
    profiles: ["alpespartners"]
    container_name: atribucion
    restart: unless-stopped
    command:
      - sh
      - -c
      - |
        python -m debugpy --listen 0.0.0.0:5678 -m flask --app src/atribucion/api run --host=0.0.0.0 -p 8000 --reload
    ports:
      - "8002:8000"
      - "5681:5678"
    volumes:
      - ./src/atribucion/:/src/atribucion/
    environment:
      - DATABASE_TYPE=mongodb
      - MONGODB_URI=mongodb://admin:admin123@mongodb:27017/alpespartners?authSource=admin
      - BROKER_HOST=broker
      - PYTHONUNBUFFERED=1
    depends_on:
      - mongodb
    networks:
      - alpespartners-network

networks:
  alpespartners-network:
    driver: bridge

volumes:
  pulsar_data:
    driver: local
  mongodb_data:
    driver: local

